<!DOCTYPE html>
<html lang="zh-TW" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>HiGoDrive</title>

  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js">
    </script>
    <![endif]-->

  <!--CSS-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="css/style.css">

  <!--JS-->
  <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
  <script src="JS/jquery.raty.js"></script>

  <!--ICON-->
  <script src="https://kit.fontawesome.com/9b78fa3fff.js" crossorigin="anonymous"></script>
</head>

<body>
  <!--上導覽列-->
  <nav class="navbar navbar-expand fixed-top navbar-dark bg-primary flex-column bd-navbar p-1">
    <span class="navbar-brand m-0 h1">HiGoDrive</span>
    <!--<a class="navbar-brand mx-2" href="#">HiGoDrive</a>-->
  </nav>

  <!--內容-->
  <main>
    <div class="container">
      <h4 class="text-center my-3">訂單紀錄</h4>
      <hr>
      <div class="accordion" id="accordion">

        <template class="taskTemplate">
          <div class="card">
            <div class="card-header px-0" id="heading">
              <button id="headingBtn" class="btn btn-block" data-toggle="collapse" data-target="#collapse"
                aria-expanded="false" aria-controls="collapse">
                <div class="row">
                  <div class="col-4 px-0">
                    <p class="mb-0"><img class="user_task" src="/assets/user-circle-regular.svg" type="image/svg+xml"
                        alt="user"></p>
                    <p id="user_id" name="user_id" class="mb-0"></p>
                  </div>
                  <div class="col-6 px-0">
                    <p id="taskdist" name="dist" class="text-primary"></p>
                    <p id="taskRoute" name="route" class="text-primary mb-0"></p>
                  </div>
                  <div class="col-2 px-0">
                    <p id="taskTag" class="tag"></p>
                    <i class="fas fa-sort-down fa-lg"></i>
                  </div>
                </div>
              </button>
            </div>
            <div id="collapse" class="collapse" aria-labelledby="heading" data-parent="#accordion">
              <div class="card-body">
                <div class="scoreOther p-2">
                  對方給你的評價：
                </div>
                <div class="scoreDone p-2">
                  你給對方的評價：
                </div>
                <form action="#">
                  <div class="score p-2">
                    請給對方一個評價：
                    <div class="scoreSelf p-2">
                    </div>
                  </div>
                  <div class="form-group">
                    <textarea class="form-control" name="scoreTextarea" rows="2" placeholder="評價敘述"></textarea>
                  </div>
                  <div class="form-row">
                    <div class="col-6">
                      <a href="report.html"><button type="button"
                          class="btn btn-success btn-block reportBtn p-2">我要申訴</button></a>
                    </div>
                    <div class="col-6">
                      <button type="submit" class="btn btn-success btn-block scoreBtn p-2">送出評價</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </template>

      </div>

      <div class="noTask d-none">
        <br>
        <h3 class="text-center">沒有訂單紀錄</h3>
        <hr>
      </div>

    </div>

  </main>

  <!--下導覽列-->
  <nav class="navbar navbar-expand fixed-bottom navbar-dark bg-primary bd-navbar py-0">
    <div class="row navbar-nav m-auto p-auto">
      <div class="col-3">
        <a class="nav-item nav-link pt-2 pb-0" href="main.html">
          <p class="text-center my-0"><i class="fas fa-home fa-lg"></i></p>
          <p class="text-center my-0">Home</p>
        </a>
      </div>
      <div class="col-3">
        <a class="nav-item nav-link pt-2 pb-0" href="search.html">
          <p class="text-center my-0"><i class="fas fa-search fa-lg"></i></p>
          <p class="text-center my-0">Search</p>
        </a>
      </div>
      <div class="col-3">
        <a class="nav-item nav-link pt-2 pb-0" href="task.html">
          <p class="text-center my-0"><i class="fas fa-tasks fa-lg"></i></p>
          <p class="text-center my-0">Task</p>
        </a>
      </div>
      <div class="col-3">
        <a class="nav-item nav-link pt-2 pb-0" href="user.html">
          <p class="text-center my-0"><i class="fas fa-user fa-lg"></i></p>
          <p class="text-center my-0">User</p>
        </a>
      </div>
    </div>
  </nav>

  <script type="text/javascript">
    $('.collapse').collapse();

    var taskId = 0;

    var getTemplate = function () {
      var tmpTask = $("template.taskTemplate").html();
      return $(tmpTask).clone();
    }

    //fake function
    function getTaskReport(id) {
      return true;
    }

    function getTaskReview(id) {
      var fakeReview = [
        {
          author_id: 12345,
          score: 1,
          comment: ""
        },
        {
          author_id: 56789,
          score: 3,
          comment: ""
        }
      ]
      return fakeReview;
    }

    function getCurrentUser() {
      let id = 56789;
      return id;
    }
    //---------------------

    function task() {
      let temp = getTemplate();
      let resvText = '<span>差事已預約尚未開始進行</span>';
      let rejectText = '<span>拒絕原因：太遠了</span>';
      let goingText = '<span>差事進行中</span>';
      let scoreText = "對方還沒有對您評價";

      //let taskInfo = getTasks(taskId);
      let isReport = getTaskReport(taskId);
      let reviewObject = getTaskReview(taskId);
      let user = getCurrentUser();

      let isFinish = true;
      let isReserve = false;
      let isReject = false;
      let isGoing = false;

      let otherScore = false;
      let otherScoreStar;
      let selfScore = false;
      let selfScoreStar;

      for (let i = 0; i < reviewObject.length; i++) {
        if (reviewObject[i]["author_id"] == user) {
          selfScore = true;
          selfScoreStar = reviewObject[i]["score"]
        } else {
          otherScore = true;
          otherScoreStar = reviewObject[i]["score"]
        }
      }

      let headingText = "heading" + taskId;
      let collapseText = "collapse" + taskId;

      //fake data
      let id = 12345;
      let location = "基隆火車站";
      let time = "2019/12/3 18:00";
      let tag = ["已完成", "已預約", "已拒絕", "進行中"];
      taskId++;

      temp.find("#heading").attr("id", headingText);
      temp.find("#headingBtn").attr("data-target", "#" + collapseText);
      temp.find("#headingBtn").attr("aria-controls", collapseText);
      temp.find("#headingBtn").attr("id", "headingBtn" + taskId);
      temp.find("#user_id").text(id);
      temp.find("#user_id").attr("id", "user_id" + taskId);
      temp.find("#taskdist").text("目的地：" + location);
      temp.find("#taskdist").attr("id", "taskdist" + taskId);
      temp.find("#taskRoute").text("時間：" + time);
      temp.find("#taskRoute").attr("id", "taskRoute" + taskId);

      if (isFinish) {
        temp.find("#taskTag").text(tag[0]);
        temp.find("#taskTag").addClass("text-success");
      }
      if (isReserve) {
        temp.find("#taskTag").text(tag[1]);
        temp.find("#taskTag").addClass("text-primary");
      }
      if (isReject) {
        temp.find("#taskTag").text(tag[2]);
        temp.find("#taskTag").addClass("text-danger");
      }
      if (isGoing) {
        temp.find("#taskTag").text(tag[3]);
        temp.find("#taskTag").addClass("text-warning");
      }

      temp.find("#taskTag").attr("id", "taskTag" + taskId);
      temp.find("#collapse").attr("aria-labelledby", headingText);
      temp.find("#collapse").attr("id", collapseText);

      if (isFinish) {

        //對方評價
        if (otherScore) {
          temp.find(".scoreOther").raty({
            number: 5,
            score: otherScoreStar,
            readOnly: true,
            path: 'assets',
            hints: ['非常差', '差', '普通', '好', '非常好'],
            starHalf: 'star-half.png',
            starOff: 'star-off.png',
            starOn: 'star-on.png',
          });
        } else {
          temp.find(".scoreOther").text(scoreText);
        }

        //我方評價
        if (selfScore) {
          temp.find(".scoreDone").raty({
            number: 5,
            score: selfScoreStar,
            readOnly: true,
            path: 'assets',
            hints: ['非常差', '差', '普通', '好', '非常好'],
            starHalf: 'star-half.png',
            starOff: 'star-off.png',
            starOn: 'star-on.png'
          });
          temp.find("form textarea, form .scoreBtn, form .score").hide();
        } else {
          temp.find(".scoreDone").hide();
        }

        //申訴
        if (isReport) {
          temp.find(".reportBtn").hide();
        }

      }

      if (isReserve) {
        temp.find(".card-body").html(resvText);
      }

      if (isReject) {
        temp.find(".card-body").html(rejectText);
      }

      if (isGoing) {
        temp.find(".card-body").html(goingText);
      }

      let output = temp[0].outerHTML;
      $("#accordion").append(output);

      $(".scoreSelf").raty({
        number: 5,
        path: 'assets',
        hints: ['非常差', '差', '普通', '好', '非常好'],
        starHalf: 'star-half.png',
        starOff: 'star-off.png',
        starOn: 'star-on.png',
        targetKeep: true,
      });
    }
  </script>
</body>

</html>