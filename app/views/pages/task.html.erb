<% provide :page_title, "Task" %>

<!--上導覽列-->
<nav class="navbar navbar-expand fixed-top navbar-dark bg-primary flex-column bd-navbar p-1">
  <span class="navbar-brand m-0 h1">HiGoDrive</span>
  <!--<a class="navbar-brand mx-2" href="#">HiGoDrive</a>-->
</nav>

<!--內容-->
<main>
  <div class="container">
    <h4 class="text-center my-3">訂單紀錄</h4>
    <hr>
    <div class="accordion" id="accordion">
    </div>
  </div>

</main>

<!--下導覽列-->
<nav class="navbar navbar-expand fixed-bottom navbar-dark bg-primary bd-navbar py-0">
  <div class="row navbar-nav m-auto p-auto">
    <div class="col-3">
      <a class="nav-item nav-link pt-2 pb-0" href="/home">
        <p class="text-center my-0"><i class="fas fa-home fa-lg"></i></p>
        <p class="text-center my-0">Home</p>
      </a>
    </div>
    <div class="col-3">
      <a class="nav-item nav-link pt-2 pb-0" href="/search">
        <p class="text-center my-0"><i class="fas fa-search fa-lg"></i></p>
        <p class="text-center my-0">Search</p>
      </a>
    </div>
    <div class="col-3">
      <a class="nav-item nav-link pt-2 pb-0" href="/task">
        <p class="text-center my-0"><i class="fas fa-tasks fa-lg"></i></p>
        <p class="text-center my-0">Task</p>
      </a>
    </div>
    <div class="col-3">
      <a class="nav-item nav-link pt-2 pb-0" href="/user">
        <p class="text-center my-0"><i class="fas fa-user fa-lg"></i></p>
        <p class="text-center my-0">User</p>
      </a>
    </div>
  </div>
</nav>

<script>

function renderTaskToPage(taskId) {
  let task = getTask(taskId);
  let placeName = task.dest.placeName;
  let depart_time = task.dest.datetimepicker;
  // TODO: author_name or driver_name
  var author_name = getUserInfo(task.author_id).username;
  var driver_name = getUserInfo(task.driver_id).username;
  var status = task.status;
  var status_msg = {
      0: "等待中",
      1: "已接受",
      2: "接客中",
      3: "已完成",
      4: "已取消"
  }[status];

  var msg = {
    0: '      <span>狀態：尚無司機接單</span>',

    1: '      <span>狀態：已被司機接單</span>',

    2: '      <span>狀態：送客中</span>',

    3: '      <form action="task.html">' +
       '        <div class="score p-2">' +
       '          <div id="score" class="target"></div>' +
       '          <div id="star" style="display: none;"></div>' +
       '        </div>' +
       '        <div class="form-group">' +
       '          <textarea class="form-control" id="scoreTextarea" name="scoreTextarea" rows="2"' +
       '            placeholder="評價敘述"></textarea>' +
       '        </div>' +
       '        <div class="form-row">' +
       '          <div class="col-6">' +
       '            <a href="report.html"><button type="button" class="btn btn-success btn-block p-2">我要申訴</button></a>' +
       '          </div>' +
       '          <div class="col-6">' +
       '            <button type="submit" class="btn btn-success btn-block p-2">送出評價</button>' +
       '          </div>' +
       '        </div>' +
       '      </form>',

    4: '      <span>取消原因：已過期</span>'
  }[status];

  $("#accordion").append('' +
      '<div class="card">' +
      '  <div class="card-header px-0" id="heading-' + taskId + '">' +
      '    <button class="btn btn-block" data-toggle="collapse" data-target="#collapse-' + taskId + '" aria-expanded="false"' +
      '      aria-controls="collapse-' + taskId + '">' +
      '      <div class="row">' +
      '        <div class="col-4 px-0">' +
      '          <p class="mb-0"><img class="user_task" src="/assets/user-circle-regular.svg" type="image/svg+xml"' +
      '              alt="user">' +
      '          </p>' +
      '          <p name="user_id" class="mb-0">' + author_name + '</p>' +
      '        </div>' +
      '        <div class="col-6 px-0">' +
      '          <p name="dist" class="text-primary">目的地：' + placeName + '</p>' +
      '          <p name="route" class="text-primary mb-0">時間：' + depart_time + '</p>' +
      '        </div>' +
      '        <div class="col-2 px-0">' +
      '          <p class="text-danger tag" id="task-status">' + status_msg + '</p>' +
      '          <i class="fas fa-sort-down fa-lg"></i>' +
      '        </div>' +
      '      </div>' +
      '    </button>' +
      '  </div>' +
      '  <div id="collapse-' + taskId + '" class="collapse" aria-labelledby="heading-' + taskId + '" data-parent="#accordion">' +
      '    <div class="card-body">' +
      msg +
      '    </div>' +
      '  </div>' +
      '</div>');

  $("#task-status").attr("class", { 0: "text-primary tag",
                                    1: "text-primary tag",
                                    2: "text-primary tag",
                                    3: "text-success tag",
                                    4: "text-danger tag" }[status]);
  $("#task-status").attr("id", "task-" + taskId + "-status");
  $('.score').raty({
    number: 5,
    targetType: 'score',
    path: 'assets',
    hints: ['非常差', '差', '普通', '好', '非常好'],
    size: 24,
    starHalf: 'star-half.png',
    starOff: 'star-off.png',
    starOn: 'star-on.png',
    target: '#star',
    cancel: false,
  });
}

$(document).ready(function() {
  let myTasks = getMyTasks();
  if (myTasks && myTasks.length) {
    myTasks.forEach(taskId => {
      renderTaskToPage(taskId);
    });
  } else {
    $("#accordion").html('' +
        '<div class="noTask">' +
        '  <h5 class="text-center alert alert-danger">沒有訂單紀錄</h5>' +
        '</div>');
  }
});
</script>
